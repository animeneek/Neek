<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neek ‚Äî Info</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root { --accent:#ff4444; --bg:#0b0b0b; --muted:#9b9b9b; }
    html,body { background:var(--bg); color:#fff; overflow-x:hidden; }
    a { color:#fff; text-decoration:none !important; }
    a:hover { color:var(--accent); }
    .star { color: var(--accent); }
    .btn {
      background:var(--accent); color:white; padding:0.5rem 1rem; border-radius:0.75rem;
      font-size:0.875rem; font-weight:600; transition:all .2s;
    }
    .btn:disabled {
      opacity:0.5; cursor:not-allowed;
    }
    .cast-img {
      width:80px; height:80px; object-fit:cover;
      border-radius:50%; border:3px solid var(--accent);
      margin:0 auto;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <div id="header"></div>

  <!-- Main -->
  <main class="flex-1 max-w-6xl mx-auto px-3 sm:px-6 py-28 space-y-16">

    <!-- Info Section -->
    <section id="info" class="flex flex-col md:flex-row gap-8"></section>

    <!-- Cast Section -->
    <section id="cast" class="mt-12">
      <h2 class="text-2xl font-bold mb-6">üë• Cast</h2>
      <div id="cast-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6"></div>
    </section>

    <!-- Watch Section -->
    <section id="watch" class="mt-12 text-center">
      <h2 class="text-2xl font-bold mb-4">üé• Watch Now</h2>
      <div id="player" class="w-full aspect-video bg-black rounded-xl flex items-center justify-center text-gray-500">
        Select an episode or source below üëá
      </div>

      <!-- Movies: Sources -->
      <div id="movie-sources" class="mt-6 flex flex-wrap gap-3 justify-center hidden"></div>

      <!-- Series: Season/Episode selection -->
      <div id="series-controls" class="mt-6 flex flex-col items-center gap-4 hidden">
        <div class="flex gap-3 flex-wrap justify-center">
          <select id="season-select" class="bg-[#1a1a1a] text-white px-3 py-2 rounded-xl">
            <option value="">Select Season</option>
          </select>
          <select id="episode-select" class="bg-[#1a1a1a] text-white px-3 py-2 rounded-xl" disabled>
            <option value="">Select Episode</option>
          </select>
          <button id="play-btn" class="btn" disabled>‚ñ∂ Play</button>
        </div>
        <div id="series-sources" class="flex flex-wrap gap-3 justify-center"></div>
      </div>
    </section>

    <!-- Recommended -->
    <section id="recommended" class="mt-12">
      <h2 class="text-2xl font-bold mb-6">‚≠ê Recommended</h2>
      <div id="recommended-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
    </section>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <script>
    // Load header/footer
    Promise.all([
      fetch("header.html").then(r => r.text()),
      fetch("footer.html").then(r => r.text())
    ]).then(([header, footer]) => {
      document.getElementById("header").innerHTML = header;
      document.getElementById("footer").innerHTML = footer;
    });

    // Parse URL params
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const type = params.get("type"); // movie | series

    const API_KEY = "e3afd4c89e3351edad9e875ff7a01f0c";
    const IMG = "https://image.tmdb.org/t/p/w500";
    const JSON_URL = "https://raw.githubusercontent.com/animeneek/MovieNeek/main/MovieNeek.json";

    async function loadInfo() {
      if (!id || !type) return;

      if (type === "movie") {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}&language=en-US`);
        const data = await res.json();
        renderMovie(data);
        loadCast(id, "movie");
        loadRecommended(id, "movie");
      } else if (type === "series") {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${API_KEY}&language=en-US`);
        const data = await res.json();
        renderSeries(data);
        loadCast(id, "tv");
        loadRecommended(id, "tv");
      }
      loadExtraSources(id, type);
    }

    function renderMovie(data) {
      const html = `
        <img src="${IMG+data.poster_path}" alt="${data.title}" class="w-64 rounded-xl shadow-lg">
        <div class="flex-1">
          <h1 class="text-3xl font-bold mb-2 text-white">${data.title}</h1>
          <p class="text-sm text-gray-400 mb-4">Movie | ${data.release_date.split("-")[0]} | <i class="fa fa-star star"></i> ${data.vote_average.toFixed(1)}</p>
          <p class="text-[--muted] mb-6">${data.overview}</p>
          <p class="text-sm text-white">
            <i class="fa-regular fa-clock mr-1"></i> ${data.runtime} min | 
            <i class="fa fa-film mr-1"></i> ${data.genres.map(g=>g.name).join(", ")}
          </p>
        </div>
      `;
      document.getElementById("info").innerHTML = html;

      document.getElementById("movie-sources").classList.remove("hidden");
      document.getElementById("player").innerHTML = `<div class="p-6 text-gray-500">Choose a source below to start watching üé¨</div>`;

      // Default Source 1
      addSourceButton("Source 1", `https://player.embed-api.stream/?id=${data.id}&type=movie`, "movie-sources");
    }

    function renderSeries(data) {
      const html = `
        <img src="${IMG+data.poster_path}" alt="${data.name}" class="w-64 rounded-xl shadow-lg">
        <div class="flex-1">
          <h1 class="text-3xl font-bold mb-2 text-white">${data.name}</h1>
          <p class="text-sm text-gray-400 mb-4">Series | ${data.first_air_date.split("-")[0]} | ${data.number_of_seasons} Seasons | <i class="fa fa-star star"></i> ${data.vote_average.toFixed(1)}</p>
          <p class="text-[--muted] mb-6">${data.overview}</p>
          <p class="text-sm text-white">
            <i class="fa fa-film mr-1"></i> ${data.genres.map(g=>g.name).join(", ")}
          </p>
        </div>
      `;
      document.getElementById("info").innerHTML = html;

      document.getElementById("series-controls").classList.remove("hidden");

      // populate seasons
      const seasonSelect = document.getElementById("season-select");
      data.seasons.forEach(s => {
        if (s.season_number > 0) {
          const opt = document.createElement("option");
          opt.value = s.season_number;
          opt.textContent = `Season ${s.season_number}`;
          seasonSelect.appendChild(opt);
        }
      });

      const episodeSelect = document.getElementById("episode-select");
      const playBtn = document.getElementById("play-btn");

      seasonSelect.addEventListener("change", async e => {
        const seasonNum = e.target.value;
        episodeSelect.innerHTML = "<option value=''>Select Episode</option>";
        episodeSelect.disabled = !seasonNum;
        playBtn.disabled = true;

        if (seasonNum) {
          const res = await fetch(`https://api.themoviedb.org/3/tv/${data.id}/season/${seasonNum}?api_key=${API_KEY}&language=en-US`);
          const seasonData = await res.json();
          seasonData.episodes.forEach(ep => {
            const opt = document.createElement("option");
            opt.value = ep.episode_number;
            opt.textContent = `Episode ${ep.episode_number}`;
            episodeSelect.appendChild(opt);
          });
        }
      });

      episodeSelect.addEventListener("change", () => {
        playBtn.disabled = !(seasonSelect.value && episodeSelect.value);
      });

      playBtn.addEventListener("click", () => {
        const s = seasonSelect.value;
        const e = episodeSelect.value;
        if (s && e) {
          document.getElementById("player").innerHTML =
            `<iframe src="https://player.embed-api.stream/?id=${data.id}&s=${s}&e=${e}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
        }
      });
    }

    async function loadCast(id, type) {
      const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}/credits?api_key=${API_KEY}`);
      const data = await res.json();
      const container = document.getElementById("cast-list");
      container.innerHTML = data.cast.slice(0, 10).map(c => `
        <a href="people.html?id=${c.id}" class="text-center">
          <img src="${c.profile_path ? IMG+c.profile_path : 'https://via.placeholder.com/80'}" class="cast-img">
          <p class="mt-2 text-sm font-semibold">${c.name}</p>
          <p class="text-xs text-gray-400">${c.character || ""}</p>
        </a>
      `).join("");
    }

    function addSourceButton(label, url, containerId) {
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = label;
      btn.onclick = () => {
        document.getElementById("player").innerHTML =
          `<iframe src="${url}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
      };
      document.getElementById(containerId).appendChild(btn);
    }

    async function loadExtraSources(id, type) {
      try {
        const res = await fetch(JSON_URL);
        const json = await res.json();
        const entry = json.find(e => e.TMDBID == id && e.Class === type);
        if (!entry) return;

        entry.SRC.forEach((src, i) => {
          let base = "";
          if (src === "streamtape") base = "https://streamtape.to/e/";
          else if (src === "streamwish") base = "https://streamwish.to/e/";
          else if (src === "mp4upload") base = "https://mp4upload.com/v/";
          else if (src === "other") base = "https://otherone.com/e/";
          else if (src === "other2") base = "https://othertwo.com/e/";

          const videoId = entry.VIDEOID[i];
          const label = entry.Source[i] || `Source ${i+2}`;
          const url = base + videoId;

          if (type === "movie") addSourceButton(label, url, "movie-sources");
          else addSourceButton(label, url, "series-sources");
        });
      } catch (e) {
        console.error("Extra sources load error", e);
      }
    }

    async function loadRecommended(id, type) {
      const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}/recommendations?api_key=${API_KEY}&language=en-US&page=1`);
      const data = await res.json();
      const container = document.getElementById("recommended-grid");

      const cards = await Promise.all(data.results.slice(0, 10).map(async item => {
        const poster = item.poster_path ? IMG+item.poster_path : "https://via.placeholder.com/500x750?text=No+Image";
        const year = item.release_date ? item.release_date.split("-")[0] :
                     item.first_air_date ? item.first_air_date.split("-")[0] : "‚Äî";
        const rating = item.vote_average ? item.vote_average.toFixed(1) : "N/A";
        const mediaType = item.media_type || (item.first_air_date ? "series" : "movie");

        let infoLine = "";
        if (mediaType === "movie") {
          infoLine = `Movie | ${year} | <i class="fa fa-star star"></i> ${rating}`;
        } else {
          const tvRes = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${API_KEY}`);
          const tvData = await tvRes.json();
          infoLine = `Series | ${year} | ${tvData.number_of_seasons} Seasons | <i class="fa fa-star star"></i> ${rating}`;
        }

        return `
          <a href="info.html?id=${item.id}&type=${mediaType}" class="card rounded-xl overflow-hidden hover:scale-105 transition block max-w-full">
            <img src="${poster}" alt="${item.title || item.name}" class="w-full h-72 object-cover">
            <div class="p-3">
              <h3 class="text-sm font-medium line-clamp-2 hover:text-[--accent] transition">${item.title || item.name}</h3>
              <p class="text-xs text-gray-400 mt-1">${infoLine}</p>
            </div>
          </a>
        `;
      }));

      container.innerHTML = cards.join("");
    }

    loadInfo();
  </script>
</body>
</html>
