<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neek — Info</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --accent: #ff4444;
      --bg: #0b0b0b;
      --muted: #9b9b9b;
    }

    html, body {
      background: var(--bg);
      color: #fff;
      overflow-x: hidden; /* prevent sideways scroll */
    }

    a { color: #fff; text-decoration: none !important; }
    a:hover { color: var(--accent); text-decoration: none !important; }

    .star { color: var(--accent); }
    .poster-img { max-width: 100%; height: auto; }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-[--bg] text-white">

  <!-- Header (will be injected) -->
  <div id="header"></div>

  <main class="flex-1 max-w-6xl w-full mx-auto px-3 sm:px-6 py-6 md:pt-28 pb-24">

    <!-- Info row -->
    <section id="info" class="flex flex-col md:flex-row gap-6 items-start"></section>

    <!-- Cast -->
    <section id="cast" class="mt-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-users text-[--accent]"></i> Cast
      </h2>
      <div id="cast-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4"></div>
    </section>

    <!-- Watch -->
    <section id="watch" class="mt-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-play-circle text-[--accent]"></i> Watch Now
      </h2>

      <div id="player" class="w-full aspect-video bg-black rounded-xl overflow-hidden flex items-center justify-center text-center text-gray-400">
        <div id="player-placeholder" class="px-6">
          <p class="text-lg font-semibold">Select a source or pick a season & episode to begin</p>
          <p class="text-sm text-[--muted] mt-2">Choose a source to stream, or use the dropdowns for series episodes.</p>
        </div>
      </div>

      <div id="sources" class="mt-4 flex flex-wrap justify-center gap-3"></div>
    </section>

    <!-- Episodes -->
    <section id="episodes" class="mt-8 hidden">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-tv text-[--accent]"></i> Episodes
      </h2>

      <div class="flex flex-col items-center gap-3">
        <div class="flex gap-3 items-center justify-center w-full">
          <select id="seasonSelect" class="bg-[#1a1a1a] border border-gray-700 rounded-xl px-3 py-2 text-sm w-48">
            <option value="">Select Season</option>
          </select>

          <select id="episodeSelect" class="bg-[#1a1a1a] border border-gray-700 rounded-xl px-3 py-2 text-sm w-48" disabled>
            <option value="">Select Episode</option>
          </select>

          <button id="playBtn" disabled
                  class="bg-[--accent] text-white px-4 py-2 rounded-xl opacity-60 cursor-not-allowed transition">
            Play
          </button>
        </div>

        <div id="series-sources" class="flex flex-wrap justify-center gap-3"></div>
      </div>
    </section>

    <!-- Recommended -->
    <section id="similar" class="mt-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-clone text-[--accent]"></i> Recommended
      </h2>
      <div id="similar-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
    </section>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Header/footer script -->
  <script>
    (async function insertHeaderFooterAndInit() {
      try {
        const [hHtml, fHtml] = await Promise.all([
          fetch('header.html').then(r => r.ok ? r.text() : ''),
          fetch('footer.html').then(r => r.ok ? r.text() : '')
        ]);
        if (hHtml) document.getElementById('header').innerHTML = hHtml;
        if (fHtml) document.getElementById('footer').innerHTML = fHtml;
      } catch (e) {
        console.warn('header/footer load failed', e);
      }

      const tryApplyPadding = () => {
        const headerEl = document.querySelector('.neek-header');
        if (!headerEl) return;
        if (window.matchMedia('(min-width: 768px)').matches) {
          const h = headerEl.getBoundingClientRect().height || 64;
          document.body.style.paddingTop = h + 'px';
        } else {
          document.body.style.paddingTop = '';
        }
      };
      tryApplyPadding();
      window.addEventListener('resize', tryApplyPadding);
    })();
  </script>

  <!-- Main logic -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const type = params.get('type');
    const API_KEY = "e3afd4c89e3351edad9e875ff7a01f0c";
    const IMG = "https://image.tmdb.org/t/p/w500";
    const FALLBACK_POSTER = "https://github.com/animeneek/Neek/blob/main/assets/images/Poster%20404%20Error.png";

    const safe = (v, f='—') => (v===null||v===undefined||v==='')?f:v;

    (async function init() {
      if (!id) return;
      if (type === 'movie') {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}&language=en-US`);
        const data = await res.json();
        renderMovie(data);
        loadCast('movie');
        loadSimilar('movie');
        loadExtraSources();
      } else if (type === 'series') {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${API_KEY}&language=en-US`);
        const data = await res.json();
        renderSeries(data);
        loadCast('tv');
        loadSimilar('tv');
        loadExtraSources();
        initSeriesControls(data);
      }
    })();

    function renderMovie(data) {
      const posterURL = data.poster_path ? IMG+data.poster_path : FALLBACK_POSTER;
      const html = `
        <div class="flex-shrink-0 w-full md:w-64">
          <img src="${posterURL}" alt="${escapeHtml(safe(data.title))}" class="rounded-xl shadow-lg poster-img w-full h-auto object-cover" />
        </div>
        <div class="flex-1">
          <h1 class="text-2xl sm:text-3xl font-bold mb-2 break-words">${escapeHtml(safe(data.title))}</h1>
          <p class="text-sm text-gray-300 mb-3">
            Movie | ${safe(getYear(data.release_date))}
            <span class="mx-2">|</span>
            <i class="fa-regular fa-clock mr-1"></i> <span class="text-white">${safe(data.runtime)} min</span>
            <span class="mx-2">|</span>
            <i class="fa fa-film mr-1"></i> <span class="text-white">${escapeHtml((data.genres||[]).map(g=>g.name).join(', ')||'—')}</span>
            <span class="mx-2">|</span>
            <i class="fa fa-star star"></i> <span class="text-white">${(data.vote_average||0).toFixed(1)}</span>
          </p>
          <p class="text-[--muted] mb-6">${escapeHtml(safe(data.overview,'No description available'))}</p>
        </div>`;
      document.getElementById('info').innerHTML = html;

      const playerURL = `https://player.embed-api.stream/?id=${data.id}&type=movie`;
      document.getElementById('player-placeholder')?.remove();
      document.getElementById('player').innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-400">Select a source to play</div>`;
      document.getElementById('sources').innerHTML = `
        <button class="src-btn bg-[--accent] text-white px-4 py-2 rounded-xl" data-url="${playerURL}">Source 1</button>
      `;
      wireSourceButtons();
    }

    function renderSeries(data) {
      const posterURL = data.poster_path ? IMG+data.poster_path : FALLBACK_POSTER;
      const html = `
        <div class="flex-shrink-0 w-full md:w-64">
          <img src="${posterURL}" alt="${escapeHtml(safe(data.name))}" class="rounded-xl shadow-lg poster-img w-full h-auto object-cover" />
        </div>
        <div class="flex-1">
          <h1 class="text-2xl sm:text-3xl font-bold mb-2 break-words">${escapeHtml(safe(data.name))}</h1>
          <p class="text-sm text-gray-300 mb-3">
            Series | ${safe(getYear(data.first_air_date))}
            <span class="mx-2">|</span>
            <span class="text-white">${safe(data.number_of_seasons)} Seasons</span>
            <span class="mx-2">|</span>
            <i class="fa fa-star star"></i> <span class="text-white">${(data.vote_average||0).toFixed(1)}</span>
          </p>
          <p class="text-[--muted] mb-6">${escapeHtml(safe(data.overview,'No description available'))}</p>
        </div>`;
      document.getElementById('info').innerHTML = html;
      document.getElementById('player-placeholder')?.remove();
      document.getElementById('player').innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-400">Select a season & episode or choose a source below to play.</div>`;
      document.getElementById('episodes').classList.remove('hidden');
    }

    async function loadCast(mediaType) {
      try {
        const res = await fetch(`https://api.themoviedb.org/3/${mediaType}/${id}/credits?api_key=${API_KEY}`);
        const data = await res.json();
        const cast = (data.cast||[]).slice(0,12);
        const html = cast.map(p=>{
          const img = p.profile_path?IMG+p.profile_path:FALLBACK_POSTER;
          return `
            <a href="people.html?id=${p.id}" class="flex flex-col items-center text-center hover:text-[--accent]">
              <div class="w-16 h-16 rounded-full overflow-hidden ring-2 ring-[--accent]">
                <img src="${img}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover">
              </div>
              <div class="mt-2 text-sm font-medium">${escapeHtml(p.name)}</div>
              <div class="text-xs text-gray-400">${escapeHtml(p.character||'')}</div>
            </a>`;
        }).join('');
        document.getElementById('cast-grid').innerHTML = html;
      } catch(e){console.error(e);}
    }

    async function loadSimilar(mediaType) {
      try {
        const res = await fetch(`https://api.themoviedb.org/3/${mediaType}/${id}/similar?api_key=${API_KEY}&language=en-US&page=1`);
        const data = await res.json();
        const items = (data.results||[]).slice(0,10);
        const html = items.map(it=>{
          const poster = it.poster_path?IMG+it.poster_path:FALLBACK_POSTER;
          const title = escapeHtml(it.title||it.name||'—');
          const linkType = (mediaType==='movie')?'movie':'series';
          const meta = (mediaType==='movie')
            ? `Movie | ${getYear(it.release_date)} | <i class="fa fa-star star"></i> ${(it.vote_average||0).toFixed(1)}`
            : `Series | ${getYear(it.first_air_date)} | ${it.number_of_seasons||'?'} Seasons | <i class="fa fa-star star"></i> ${(it.vote_average||0).toFixed(1)}`;
          return `
            <a href="info.html?id=${it.id}&type=${linkType}" class="block rounded-xl overflow-hidden hover:scale-105 transition bg-[#1a1a1a]">
              <img src="${poster}" class="w-full h-72 object-cover" alt="${title}">
              <div class="p-2">
                <p class="text-sm font-bold line-clamp-1">${title}</p>
                <p class="text-xs text-gray-400">${meta}</p>
              </div>
            </a>`;
        }).join('');
        document.getElementById('similar-grid').innerHTML = html;
      } catch(e){console.error(e);}
    }

    async function loadExtraSources() {
      try {
        const raw = await fetch('https://raw.githubusercontent.com/animeneek/MovieNeek/main/MovieNeek.json');
        const arr = await raw.json();
        const match = arr.find(x=>String(x.TMDBID)===String(id));
        if (!match) return;
        const sourcesEl=document.getElementById('sources');
        const seriesSourcesEl=document.getElementById('series-sources');
        for(let i=0;i<(match.SRC||[]).length;i++){
          const src=match.SRC[i];const label=match.Source?.[i]||`Source ${i+2}`;const vid=match.VIDEOID?.[i];
          if(!vid)continue;
          const url=src==='streamtape'?`https://streamtape.to/e/${vid}`:
                    src==='streamwish'?`https://streamwish.to/e/${vid}`:
                    src==='mp4upload'?`https://mp4upload.com/v/${vid}`:
                    src==='other'?`https://otherone.com/e/${vid}`:
                    src==='other2'?`https://othertwo.com/e/${vid}`:`https://example.com/e/${vid}`;
          const btn=document.createElement('button');
          btn.className='bg-[--accent] text-white px-4 py-2 rounded-xl';
          btn.textContent=label;btn.dataset.url=url;
          btn.addEventListener('click',()=>{loadPlayer(url);});
          if(type==='movie'){sourcesEl.appendChild(btn);}else{seriesSourcesEl.appendChild(btn);}
        }
        sourcesEl.classList.add('justify-center');
      } catch(e){console.warn(e);}
    }

    function wireSourceButtons() {
      document.getElementById('sources').addEventListener('click',ev=>{
        const t=ev.target.closest('button');if(!t)return;const url=t.dataset.url;if(!url)return;loadPlayer(url);
      });
    }

    function loadPlayer(url){
      if(!url)return;
      const player=document.getElementById('player');
      player.innerHTML=`<iframe src="${url}" class="w-full h-full rounded-xl" frameborder="0" allowfullscreen></iframe>`;
      player.scrollIntoView({behavior:'smooth',block:'center'});
    }

    function initSeriesControls(seriesData) {
      try {
        const seasonSelect = document.getElementById('seasonSelect');
        const episodeSelect = document.getElementById('episodeSelect');
        const playBtn = document.getElementById('playBtn');

        // populate seasons (exclude season 0 if exists)
        (seriesData.seasons || []).forEach(s => {
          if (s.season_number && s.season_number > 0) {
            const opt = document.createElement('option');
            opt.value = s.season_number;
            opt.textContent = `Season ${s.season_number}`;
            seasonSelect.appendChild(opt);
          }
        });

        seasonSelect.addEventListener('change', async () => {
          episodeSelect.innerHTML = '<option value="">Select Episode</option>';
          episodeSelect.disabled = true;
          playBtn.disabled = true;
          playBtn.classList.add('opacity-60', 'cursor-not-allowed');
          const sn = seasonSelect.value;
          if (!sn) return;
          try {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${sn}?api_key=${API_KEY}&language=en-US`);
            const sd = await res.json();
            (sd.episodes || []).forEach(ep => {
              const o = document.createElement('option');
              o.value = ep.episode_number;
              o.textContent = `Episode ${ep.episode_number} — ${ep.name || ''}`;
              episodeSelect.appendChild(o);
            });
            episodeSelect.disabled = false;
          } catch (e) {
            console.error('Failed season fetch', e);
          }
        });

        episodeSelect.addEventListener('change', () => {
          if (episodeSelect.value && seasonSelect.value) {
            playBtn.disabled = false;
            playBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          } else {
            playBtn.disabled = true;
            playBtn.classList.add('opacity-60', 'cursor-not-allowed');
          }
        });

        playBtn.addEventListener('click', () => {
          const s = seasonSelect.value;
          const e = episodeSelect.value;
          if (s && e) {
            const url = `https://player.embed-api.stream/?id=${id}&s=${s}&e=${e}`;
            loadPlayer(url);
          }
        });
      } catch (err) {
        console.error('initSeriesControls error', err);
      }
    }

    // small helpers
    function getYear(dateStr) {
      if (!dateStr) return '—';
      return (dateStr.split && dateStr.split('-')[0]) || dateStr;
    }
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
