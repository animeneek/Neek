<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neek — Anime Info</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --accent: #ff4444;
      --bg: #0b0b0b;
      --muted: #9b9b9b;
    }
    html, body { background: var(--bg); color: #fff; overflow-x: hidden; }
    a { color: #fff; text-decoration: none !important; }
    a:hover { color: var(--accent); }
    .star { color: var(--accent); }
    .ep-btn.active { background: var(--accent); color: #fff; box-shadow: 0 0 10px rgba(255,68,68,0.7); }
    .source-btn.active { background: var(--accent); color: #fff; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-[--bg] text-white">

  <!-- Header -->
  <div id="header"></div>

  <main class="flex-1 max-w-6xl w-full mx-auto px-3 sm:px-6 py-6 md:pt-28 pb-24">
    
    <!-- Info -->
    <section id="info" class="flex flex-col md:flex-row gap-6 items-start"></section>

    <!-- Watch -->
    <section id="watch" class="mt-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-play-circle text-[--accent]"></i> Watch Now
      </h2>
      <div id="player" class="w-full aspect-video bg-black rounded-xl overflow-hidden flex items-center justify-center text-center text-gray-400">
        <div id="player-placeholder" class="px-6">
          <p class="text-lg font-semibold">Select an episode to start watching</p>
        </div>
      </div>

      <!-- Episodes & Sources -->
      <div class="mt-6 bg-gradient-to-br from-[#1a1a1a] to-[#111] rounded-2xl p-6 shadow-lg">
        <!-- Episodes Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="fa fa-list-ol text-[--accent]"></i> Episodes
          </h3>
          <select id="episodeDropdown" class="bg-[#0b0b0b] border border-gray-700 rounded-md px-3 py-2 text-sm">
            <option value="">Select episode</option>
          </select>
        </div>

        <!-- Episode Buttons Carousel -->
        <div id="episodes" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>

        <!-- Sources -->
        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
            <i class="fa fa-database text-[--accent]"></i> Source
          </h3>
          <div id="sources" class="flex gap-3 flex-wrap"></div>
        </div>
      </div>
    </section>

    <!-- Characters -->
    <section id="characters" class="mt-10">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-users text-[--accent]"></i> Characters & Voice Actors
      </h2>
      <div id="characters-grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <!-- Staff -->
    <section id="staff" class="mt-10">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-user-tie text-[--accent]"></i> Staff
      </h2>
      <div id="staff-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4"></div>
    </section>

    <!-- Recommendations -->
    <section id="recommendations" class="mt-10">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fa fa-clone text-[--accent]"></i> Recommended
      </h2>
      <div id="recommendations-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
    </section>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Header/footer script -->
  <script>
    (async function insertHeaderFooterAndInit() {
      try {
        const [hHtml, fHtml] = await Promise.all([
          fetch('header.html').then(r => r.ok ? r.text() : ''),
          fetch('footer.html').then(r => r.ok ? r.text() : '')
        ]);
        if (hHtml) document.getElementById('header').innerHTML = hHtml;
        if (fHtml) document.getElementById('footer').innerHTML = fHtml;
      } catch (e) {
        console.warn('header/footer load failed', e);
      }

      const tryApplyPadding = () => {
        const headerEl = document.querySelector('.neek-header');
        if (!headerEl) return;
        if (window.matchMedia('(min-width: 768px)').matches) {
          const h = headerEl.getBoundingClientRect().height || 64;
          document.body.style.paddingTop = h + 'px';
        } else {
          document.body.style.paddingTop = '';
        }
      };
      tryApplyPadding();
      window.addEventListener('resize', tryApplyPadding);
    })();
  </script>

  <!-- Main logic -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const ANILIST_API = "https://graphql.anilist.co";
    const FALLBACK_IMG = "https://github.com/animeneek/Neek/blob/main/assets/images/Poster%20404%20Error.png?raw=true";
    const EPISODES_JSON = "https://raw.githubusercontent.com/animeneek/AN/main/episodes.json";

    let currentEpisode = null;
    let currentSource = null;
    let availableSources = [];

    const query = `
      query($id: Int) {
        Media(id: $id, type: ANIME) {
          id
          title { romaji english native }
          description(asHtml: false)
          coverImage { large }
          bannerImage
          startDate { year }
          episodes
          status
          averageScore
          genres
          characters(sort: ROLE, perPage: 12) {
            edges {
              role
              node { id name { full } image { large } }
              voiceActors(sort: RELEVANCE) {
                id
                languageV2
                name { full }
                image { large }
              }
            }
          }
          staff(perPage: 12) {
            edges {
              role
              node { id name { full } image { large } }
            }
          }
          recommendations(perPage: 10) {
            edges {
              node {
                mediaRecommendation {
                  id
                  title { romaji }
                  coverImage { large }
                  averageScore
                  status
                  episodes
                }
              }
            }
          }
        }
      }
    `;

    async function fetchAnime() {
      const res = await fetch(ANILIST_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, variables: { id: Number(id) } })
      });
      const json = await res.json();
      renderAnime(json.data.Media);
    }

    async function fetchEpisodes(animeId) {
      try {
        const res = await fetch(EPISODES_JSON);
        const all = await res.json();
        return all.find(x => x.id === String(animeId));
      } catch (e) {
        console.warn("Failed to fetch episodes", e);
        return null;
      }
    }

    function safeImg(src) {
      return src || FALLBACK_IMG;
    }

    function renderEpisodes(entry) {
      const epContainer = document.getElementById("episodes");
      const epDropdown = document.getElementById("episodeDropdown");
      epContainer.innerHTML = "";
      epDropdown.innerHTML = `<option value="">Select episode</option>`;
      if (!entry) return;

      entry.episodes.forEach(ep => {
        const btn = document.createElement("button");
        btn.className = "ep-btn px-4 py-2 rounded-full bg-[#0b0b0b] border border-gray-700 text-sm hover:bg-[--accent] hover:text-white transition whitespace-nowrap";
        btn.textContent = `Ep ${ep.episode}`;
        btn.onclick = () => selectEpisode(entry, ep.episode);
        epContainer.appendChild(btn);

        const opt = document.createElement("option");
        opt.value = ep.episode;
        opt.textContent = `Episode ${ep.episode}`;
        epDropdown.appendChild(opt);
      });

      epDropdown.onchange = e => {
        if (e.target.value) selectEpisode(entry, e.target.value);
      };
    }

    function selectEpisode(entry, episodeNum) {
      currentEpisode = entry.episodes.find(e => e.episode === String(episodeNum));
      document.querySelectorAll(".ep-btn").forEach(b => {
        b.classList.toggle("active", b.textContent.includes(`Ep ${episodeNum}`));
      });
      document.getElementById("episodeDropdown").value = episodeNum;
      renderSources(entry);
    }

    function renderSources(entry) {
      const srcContainer = document.getElementById("sources");
      srcContainer.innerHTML = "";
      if (!currentEpisode) return;

      const sourceMap = {
        "anime": ["sub", "dub"],
        "anime-raw": ["raw"],
        "hanime": ["raw"],
        "hanime-sub": ["sub"],
        "hanime-dub": ["dub"]
      };

      availableSources = sourceMap[entry.type] || ["sub"];

      availableSources.forEach(src => {
        const btn = document.createElement("button");
        btn.className = "source-btn px-4 py-2 rounded-md bg-[#0b0b0b] border border-gray-700 text-sm hover:bg-[--accent] hover:text-white transition";
        btn.textContent = src.toUpperCase();
        btn.onclick = () => selectSource(entry, src, btn);
        srcContainer.appendChild(btn);
      });
    }

    function selectSource(entry, source, btn) {
      currentSource = source;
      document.querySelectorAll(".source-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      let url = "";
      switch (entry.type) {
        case "anime":       url = `https://megaplay.buzz/stream/s-2/${currentEpisode.id}/${source}`; break;
        case "anime-raw":   url = `https://exampleanimeraw.com/e/${currentEpisode.id}`; break;
        case "hanime-mp4":      url = `https://www.mp4upload.com/embed-${currentEpisode.id}.html`; break;
        case "hanime-mp4-sub":  url = `https://www.mp4upload.com/embed-${currentEpisode.id}.html`; break;
        case "hanime-mp4-dub":  url = `https://www.mp4upload.com/embed-${currentEpisode.id}.html`; break;
        case "1hanime":      url = `https://r2.1hanime.com/${currentEpisode.id}.mp4`; break;
        case "1hanime-sub":  url = `https://r2.1hanime.com/${currentEpisode.id}.mp4`; break;
        case "1hanime-dub":  url = `https://r2.1hanime.com/${currentEpisode.id}.mp4`; break;
      }

      document.getElementById("player").innerHTML = `<iframe src="${url}" allowfullscreen class="w-full h-full"></iframe>`;
    }

    async function renderAnime(media) {
      // Info
      document.getElementById("info").innerHTML = `
        <div class="flex-shrink-0 w-full md:w-64">
          <img src="${safeImg(media.coverImage?.large)}" class="rounded-xl shadow-lg w-full object-cover" />
        </div>
        <div class="flex-1">
          <h1 class="text-2xl sm:text-3xl font-bold mb-2">${media.title.romaji || media.title.english}</h1>
          <p class="text-sm text-gray-300 mb-3">
            Anime | ${media.startDate?.year || "—"}
            <span class="mx-2">|</span>
            Episodes: ${media.episodes || "?"}
            <span class="mx-2">|</span>
            <i class="fa fa-star star"></i> ${(media.averageScore ? (media.averageScore/10).toFixed(1) : "—")}
          </p>
          <p class="mb-3 text-sm text-[--accent]">${media.genres?.join(", ") || "Unknown genres"}</p>
          <p class="text-[--muted] mb-6 line-clamp-6">${media.description || "No description available."}</p>
        </div>
      `;

      // Episodes
      const entry = await fetchEpisodes(media.id);
      renderEpisodes(entry);

      // Characters
      const chars = media.characters?.edges || [];
      document.getElementById("characters-grid").innerHTML = chars.map(edge => {
        const char = edge.node;
        const va = edge.voiceActors?.[0];
        return `
          <div class="relative bg-[#1a1a1a] rounded-xl p-3 flex gap-3 items-start">
            <a href="character.html?id=${char.id}" class="flex gap-3">
              <img src="${safeImg(char.image?.large)}" class="w-20 h-24 rounded-lg object-cover"/>
              <div>
                <p class="font-bold">${char.name.full}</p>
                <p class="text-xs text-gray-400">${edge.role}</p>
              </div>
            </a>
            ${va ? `
              <a href="staff.html?id=${va.id}" class="absolute bottom-2 right-2 flex items-center gap-2">
                <div class="text-right">
                  <p class="font-medium">${va.name.full}</p>
                  <p class="text-xs text-gray-400">${va.languageV2}</p>
                </div>
                <img src="${safeImg(va.image?.large)}" class="w-12 h-12 rounded-full object-cover ring-2 ring-[--accent]"/>
              </a>
            ` : ""}
          </div>
        `;
      }).join("");

      // Staff
      const staff = media.staff?.edges || [];
      document.getElementById("staff-grid").innerHTML = staff.map(edge => {
        const st = edge.node;
        return `
          <a href="staff.html?id=${st.id}" class="flex flex-col items-center text-center hover:text-[--accent]">
            <div class="w-16 h-16 rounded-full overflow-hidden ring-2 ring-[--accent]">
              <img src="${safeImg(st.image?.large)}" class="w-full h-full object-cover">
            </div>
            <div class="mt-2 text-sm font-medium">${st.name.full}</div>
            <div class="text-xs text-gray-400">${edge.role}</div>
          </a>
        `;
      }).join("");

      // Recommendations
      const recs = media.recommendations?.edges || [];
      document.getElementById("recommendations-grid").innerHTML = recs.map(r => {
        const rec = r.node.mediaRecommendation;
        return `
          <a href="info.html?id=${rec.id}&type=anime" class="block rounded-xl overflow-hidden hover:scale-105 transition bg-[#1a1a1a]">
            <img src="${safeImg(rec.coverImage?.large)}" class="w-full h-72 object-cover" />
            <div class="p-2">
              <p class="text-sm font-bold line-clamp-1">${rec.title.romaji}</p>
              <p class="text-xs text-gray-400">
                ${rec.status || "—"} | ${rec.episodes || "?"} eps |
                <i class="fa fa-star star"></i> ${(rec.averageScore ? (rec.averageScore/10).toFixed(1) : "—")}
              </p>
            </div>
          </a>
        `;
      }).join("");
    }

    fetchAnime();
  </script>
</body>
</html>
