<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neek — Person</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --accent:#ff4444;
      --bg:#0b0b0b;
      --muted:#9b9b9b;
    }

    html,body {
      background:var(--bg);
      color:#fff;
      overflow-x:hidden;
    }

    a {
      color:#fff;
      text-decoration:none !important;
    }
    a:hover {
      color:var(--accent);
    }

    .card { background:#1a1a1a; }
    .card h3 { color:#fff; }
    .star { color:var(--accent); }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-[#0b0b0b] text-white">

  <!-- Header include -->
  <div id="header"></div>

  <main class="flex-1 max-w-6xl w-full mx-auto px-3 sm:px-6 py-6 md:pt-28 pb-24 space-y-16">

    <!-- Person Info -->
    <section id="person-info" 
             class="flex flex-col md:flex-row gap-6 items-start md:items-stretch w-full"></section>

    <!-- Filmography -->
    <section id="credits">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <i class="fa fa-film text-[--accent]"></i> Known For
      </h2>

      <!-- Tabs -->
      <div id="credit-tabs" class="flex flex-wrap gap-6 border-b border-gray-700 mb-6"></div>

      <!-- Grid -->
      <div id="credits-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 sm:gap-6"></div>
    </section>
  </main>

  <!-- Footer include -->
  <div id="footer"></div>

  <script>
    // Load header & footer
    Promise.all([
      fetch("header.html").then(r => r.text()),
      fetch("footer.html").then(r => r.text())
    ]).then(([header, footer]) => {
      document.getElementById("header").innerHTML = header;
      document.getElementById("footer").innerHTML = footer;
    });

    // TMDB
    const API_KEY = "e3afd4c89e3351edad9e875ff7a01f0c";
    const IMG = "https://image.tmdb.org/t/p/w500";
    const FALLBACK_POSTER = "https://github.com/animeneek/Neek/blob/main/assets/images/Poster%20404%20Error.png?raw=true";

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    let allCredits = {};

    if (id) {
      loadPerson(id);
      loadCredits(id);
    }

    async function loadPerson(personId) {
      const res = await fetch(`https://api.themoviedb.org/3/person/${personId}?api_key=${API_KEY}&language=en-US`);
      const data = await res.json();

      const profile = data.profile_path ? IMG + data.profile_path : FALLBACK_POSTER;

      const html = `
        <div class="w-full md:w-64 flex-shrink-0">
          <img src="${profile}" alt="${data.name}" class="rounded-xl shadow-lg w-full h-auto object-cover" />
        </div>
        <div class="flex-1 min-w-0 md:ml-6 mt-4 md:mt-0 break-words">
          <h1 class="text-2xl sm:text-3xl font-bold mb-4">${data.name}</h1>
          <p class="text-sm text-gray-300 mb-3 flex flex-wrap gap-4">
            ${data.birthday ? `<span><i class="fa fa-birthday-cake mr-2 text-[--accent]"></i>${data.birthday}</span>` : ""}
            ${data.place_of_birth ? `<span><i class="fa fa-map-marker-alt mr-2 text-[--accent]"></i>${data.place_of_birth}</span>` : ""}
          </p>
          <p class="text-[--muted] leading-relaxed whitespace-pre-line">
            ${data.biography || "No biography available."}
          </p>
        </div>
      `;

      document.getElementById("person-info").innerHTML = html;
    }

    async function loadCredits(personId) {
      const res = await fetch(`https://api.themoviedb.org/3/person/${personId}/combined_credits?api_key=${API_KEY}&language=en-US`);
      const data = await res.json();

      allCredits = {};

      // Group by department
      (data.cast || []).forEach(item => {
        if (!allCredits["Acting"]) allCredits["Acting"] = [];
        allCredits["Acting"].push(item);
      });

      (data.crew || []).forEach(item => {
        const dept = item.department || "Other";
        if (!allCredits[dept]) allCredits[dept] = [];
        allCredits[dept].push(item);
      });

      // Render tabs
      renderTabs();

      // Show first tab by default
      const firstDept = allCredits["Acting"] ? "Acting" : Object.keys(allCredits)[0];
      showDepartment(firstDept);
    }

    function renderTabs() {
      const tabs = Object.keys(allCredits).map(dept => {
        return `<button class="tab-btn pb-2 text-gray-400 hover:text-[--accent] transition" 
                  data-dept="${dept}">
                  ${dept} (${allCredits[dept].length})
                </button>`;
      }).join("");

      document.getElementById("credit-tabs").innerHTML = tabs;

      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          showDepartment(btn.dataset.dept);
        });
      });
    }

    function showDepartment(dept) {
      const credits = allCredits[dept] || [];

      // Sort by date (latest first)
      credits.sort((a, b) => {
        const dateA = new Date(a.release_date || a.first_air_date || "1900-01-01");
        const dateB = new Date(b.release_date || b.first_air_date || "1900-01-01");
        return dateB - dateA;
      });

      const html = credits.map(item => {
        const id = item.id;
        const title = item.title || item.name;
        const rating = item.vote_average ? item.vote_average.toFixed(1) : "N/A";

        let mediaType = item.media_type;
        if (mediaType === "tv") mediaType = "series";

        const poster = item.poster_path ? IMG + item.poster_path : FALLBACK_POSTER;
        const year = item.release_date ? item.release_date.split("-")[0] :
                     item.first_air_date ? item.first_air_date.split("-")[0] : "—";

        let infoLine = "";
        if (mediaType === "movie") {
          infoLine = `Movie | ${year} | <i class="fa fa-star star"></i> ${rating}`;
        } else {
          infoLine = `Series | ${year} | <i class="fa fa-star star"></i> ${rating}`;
        }

        return `
          <a href="info.html?id=${id}&type=${mediaType}" 
             class="card rounded-xl overflow-hidden hover:scale-105 transition block">
            <img src="${poster}" alt="${title}" class="w-full h-72 object-cover">
            <div class="p-3">
              <h3 class="text-sm font-medium line-clamp-2 hover:text-[--accent] transition">${title}</h3>
              <p class="text-xs text-gray-400 mt-1">${infoLine}</p>
            </div>
          </a>
        `;
      }).join("");

      document.getElementById("credits-grid").innerHTML = html;

      // Update active tab style
      document.querySelectorAll(".tab-btn").forEach(b => {
        if (b.dataset.dept === dept) {
          b.classList.add("text-[--accent]", "border-b-2", "border-[--accent]");
          b.classList.remove("text-gray-400");
        } else {
          b.classList.remove("text-[--accent]", "border-b-2", "border-[--accent]");
          b.classList.add("text-gray-400");
        }
      });
    }
  </script>
</body>
</html>
